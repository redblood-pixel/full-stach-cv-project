<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система учета игрушек в детском саду</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .result-container {
            position: relative;
            display: inline-block;
        }
        .detection-label {
            position: absolute;
            background-color: rgba(0, 255, 0, 0.7);
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 3px;
            z-index: 10;
        }
        .webcam-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 20px auto;
        }
        #webcam-feed {
            width: 100%;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #ccc;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-active {
            background-color: #10B981;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Система учета игрушек в детском саду</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Основной функционал -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Анализ изображений и видео</h2>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="file-upload">
                        Загрузите изображение или видео с игрушками:
                    </label>
                    <input class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                           type="file" id="file-upload" accept="image/*,video/*">
                </div>
                
                <button id="analyze-btn"
                        class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 mr-2">
                    Анализировать
                </button>
                
                <div id="loading" class="hidden mt-4">
                    <div class="flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Обработка...
                    </div>
                </div>
                
                <div id="result" class="mt-4 hidden">
                    <h3 class="text-lg font-semibold mb-2">Результаты анализа:</h3>
                </div>
            </div>
            
            <!-- Статистика и отчеты -->
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4">Статистика и отчеты</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-blue-50 rounded-lg">
                        <h3 class="text-sm font-semibold text-blue-800">Всего анализов</h3>
                        <p id="total-requests" class="text-2xl font-bold text-blue-900">0</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg">
                        <h3 class="text-sm font-semibold text-green-800">Всего детекций</h3>
                        <p id="total-detections" class="text-2xl font-bold text-green-900">0</p>
                    </div>
                </div>
                
                <div>
                    <h3 class="text-lg font-semibold mb-2">Активность по дням</h3>
                    <canvas id="timeline-chart" width="400" height="200"></canvas>
                </div>
            </div>
            
            <!-- История запросов -->
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold mb-4">История запросов</h2>
                <div id="history" class="space-y-2">
                    <!-- История будет загружена через JavaScript -->
                </div>
                
                <!-- Пагинация удалена согласно требованиям -->
            </div>
        </div>
    </div>

    <script>
        // Глобальные переменные
        let chartTimeline = null;
        let historyData = null;

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            loadStatistics();
            
            // Настройка обработчиков событий
            document.getElementById('analyze-btn').addEventListener('click', analyzeFile);
        });

        // Функция для загрузки истории запросов
        async function loadHistory() {
            try {
                // Загружаем данные только если они еще не загружены
                if (historyData === null) {
                    const response = await fetch('/history');
                    historyData = await response.json();
                    // Сортируем по дате в обратном порядке (новые сначала)
                    historyData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
                
                const historyContainer = document.getElementById('history');
                historyContainer.innerHTML = '';
                
                // Создаем список истории (без пагинации)
                const historyList = document.createElement('ul');
                historyList.className = 'divide-y divide-gray-200';
                
                historyData.forEach(entry => {
                    const listItem = document.createElement('li');
                    listItem.className = 'py-2';
                    
                    // Форматируем дату
                    const date = new Date(entry.timestamp);
                    const formattedDate = date.toLocaleDateString('ru-RU', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Определяем тип анализа и количество объектов
                    let analysisType = '';
                    let objectCount = 0;
                    if (entry.type === 'image_upload') {
                        analysisType = 'Изображение';
                        objectCount = Object.values(entry.summary).reduce((sum, count) => sum + count, 0);
                    } else if (entry.type === 'video_analysis') {
                        analysisType = 'Видео';
                        objectCount = Object.values(entry.summary).reduce((sum, count) => sum + count, 0);
                    }
                    
                    // Создаем элемент истории
                    let pdfButton = '';
                    if (entry.type === 'video_analysis') {
                        pdfButton = `
                            <button onclick="generateVideoPDFReport(${entry.id}); event.stopPropagation();"
                                    class="ml-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition duration-300">
                                PDF отчет
                            </button>`;
                    }
                    
                    listItem.innerHTML = `
                        <div class="flex items-center justify-between cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="showHistoryDetail(${entry.id})">
                            <div class="flex-1">
                                <h3 class="text-md font-medium text-gray-900">
                                    ${analysisType} #${entry.id}
                                </h3>
                                <p class="text-sm text-gray-500">
                                    ${formattedDate} | Найдено: ${objectCount} объектов
                                </p>
                            </div>
                            <div class="flex items-center">
                                ${pdfButton}
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                    `;
                    
                    historyList.appendChild(listItem);
                });
                
                if (historyData.length === 0) {
                    historyContainer.innerHTML = '<p class="text-gray-500">История запросов пуста</p>';
                } else {
                    historyContainer.appendChild(historyList);
                }
                
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Функция для отображения деталей записи истории
        async function showHistoryDetail(entryId) {
            try {
                const response = await fetch('/history');
                const history = await response.json();
                
                // Находим нужную запись
                const entry = history.find(e => e.id === entryId);
                if (!entry) return;
                
                // Создаем модальное окно
                const modal = document.createElement('div');
                modal.id = 'history-modal';
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50';
                modal.style.display = 'block';
                
                // Определяем тип анализа
                let analysisType = '';
                if (entry.type === 'image_upload') {
                    analysisType = 'Анализ изображения';
                } else if (entry.type === 'video_analysis') {
                    analysisType = 'Анализ видео';
                }
                
                // Форматируем дату
                const date = new Date(entry.timestamp);
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                // Создаем содержимое модального окна
                modal.innerHTML = `
                    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-2/3 shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <div class="flex items-center justify-between">
                                <h3 class="text-lg leading-6 font-medium text-gray-900">
                                    ${analysisType} #${entry.id}
                                </h3>
                                <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="mt-2 px-7 py-3">
                                <p class="text-sm text-gray-500 mb-4">
                                    Дата: ${formattedDate}
                                </p>
                
                                <!-- Отображение результата -->
                                ${entry.result_image ? `
                                <div class="mt-4">
                                    <h4 class="text-md font-medium text-gray-900 mb-2">Результат анализа:</h4>
                                    <img src="/${entry.result_image}" alt="Результат анализа" class="max-w-full h-auto rounded-lg border">
                                </div>
                                ` : ''}
                
                                <!-- Отображение кадров видео, если это анализ видео -->
                                ${entry.frame_results ? `
                                <div class="mt-4">
                                    <h4 class="text-md font-medium text-gray-900 mb-2">Кадры из видео:</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-2">
                                        ${entry.frame_results.map(frame => `
                                        <div class="border rounded-lg p-2">
                                            <img src="/${frame.result_image}" alt="Кадр видео" class="w-full h-auto rounded">
                                            <p class="text-xs text-gray-500 mt-1">Кадр #${frame.frame_number}</p>
                                        </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                                
                                <!-- Кнопка для генерации PDF отчета для видео анализа -->
                                ${entry.type === 'video_analysis' ? `
                                <div class="mt-6">
                                    <button onclick="generateVideoPDFReport(${entry.id})"
                                            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                                        Сгенерировать PDF отчет
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error showing history detail:', error);
            }
        }

        // Функция для генерации PDF отчета для видео анализа
        async function generateVideoPDFReport(entryId) {
            if (!entryId) {
                alert('Не указан ID видео для генерации отчета.');
                return;
            }
            
            // Показываем индикатор загрузки
            document.getElementById('loading').classList.remove('hidden');
            
            try {
                const response = await fetch('/generate-pdf-report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ video_id: entryId })
                });
                
                if (response.ok) {
                    // Создаем временный элемент для скачивания
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `video_analysis_report_${new Date().toISOString().split('T')[0]}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    const error = await response.json();
                    alert('Ошибка при генерации PDF отчета: ' + error.error);
                }
            } catch (error) {
                alert('Ошибка при генерации PDF отчета: ' + error.message);
            } finally {
                // Скрываем индикатор загрузки
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Функция для закрытия модального окна
        function closeHistoryModal() {
            const modal = document.getElementById('history-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        // Функция для загрузки статистики
        async function loadStatistics() {
            try {
                const response = await fetch('/history');
                const history = await response.json();
                
                // Общая статистика
                document.getElementById('total-requests').textContent = history.length;
                
                let totalDetections = 0;
                const timeline = {};
                
                history.forEach(entry => {
                    // Подсчет общего количества детекций
                    if (entry.detections) {
                        totalDetections += entry.detections.length;
                    } else if (entry.frame_results) {
                        // Для видео анализируем все кадры
                        entry.frame_results.forEach(frame => {
                            totalDetections += frame.detections.length;
                        });
                    }
                    
                    // Таймлайн по дням
                    const date = entry.timestamp.split('T')[0];
                    if (!timeline[date]) {
                        timeline[date] = 0;
                    }
                    timeline[date] += 1;
                });
                
                document.getElementById('total-detections').textContent = totalDetections;
                
                // Построение графика активности по дням
                renderTimelineChart(timeline);
                
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Построение графика активности по дням
        function renderTimelineChart(timeline) {
            const ctx = document.getElementById('timeline-chart').getContext('2d');
            
            // Сортировка по дате
            const sortedEntries = Object.entries(timeline).sort();
            const labels = sortedEntries.map(entry => entry[0]);
            const data = sortedEntries.map(entry => entry[1]);
            
            if (chartTimeline) {
                chartTimeline.destroy();
            }
            
            chartTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Количество анализов',
                        data: data,
                        fill: false,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Анализ загруженного файла (изображения или видео)
        async function analyzeFile() {
            const fileInput = document.getElementById('file-upload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Пожалуйста, выберите файл для анализа');
                return;
            }
            
            // Показываем индикатор загрузки
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Скрываем индикатор загрузки и показываем результат
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('result').classList.remove('hidden');
                    
                    // Обновляем историю и статистику
                    await loadHistory();
                    await loadStatistics();
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    alert('Ошибка при анализе: ' + (result.error || 'Неизвестная ошибка'));
                }
            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                alert('Ошибка при отправке запроса: ' + error.message);
            }
        }
    </script>
</body>
</html>